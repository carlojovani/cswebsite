[file name]: profile.html
[file content begin]
{% extends 'users/base.html' %}

{% block title %}Профиль {{ profile_user.username }}{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Заголовок профиля -->
    <div class="profile-header">
        <div class="profile-avatar">
            {% if profile_user.user_type == 'player' and player_profile and player_profile.avatar %}
                <img src="{{ player_profile.avatar }}" alt="{{ profile_user.username }}" class="avatar-img">
            {% else %}
                <div class="avatar-placeholder">
                    Нет фото
                </div>
            {% endif %}
        </div>

        <div class="profile-info">
            <h1>{{ profile_user.username }}</h1>
            <div class="profile-badges">
                {% if profile_user.user_type == 'player' %}
                    <span class="badge badge-player">Игрок</span>
                {% else %}
                    <span class="badge badge-team">Команда</span>
                {% endif %}

                {% if profile_user.is_superuser %}
                    <span class="badge badge-admin">Админ</span>
                {% endif %}

                {% if profile_user.user_type == 'player' and player_profile and player_profile.is_verified %}
                    <span class="badge badge-verified">Проверен</span>
                {% endif %}
            </div>

            <p class="profile-faceit">
                <strong>Faceit:</strong>
                {% if profile_user.faceit_nickname %}
                    <a href="https://www.faceit.com/en/players/{{ profile_user.faceit_nickname }}"
                       target="_blank" class="faceit-link">
                        {{ profile_user.faceit_nickname }}
                    </a>
                {% else %}
                    Не указан
                {% endif %}
            </p>

            <p class="profile-email">
                <strong>Email:</strong> {{ profile_user.email|default:"Не указан" }}
            </p>

            <p class="profile-date">
                <strong>Регистрация:</strong> {{ profile_user.date_joined|date:"d.m.Y" }}
            </p>
        </div>

        {% if request.user == profile_user %}
        <div class="profile-actions">
            {% if profile_user.user_type == 'player' %}
                <a href="{% url 'update_faceit_data' %}" class="btn btn-update">
                    Обновить с Faceit
                </a>
            {% else %}
                <!-- ИСПРАВЛЕННАЯ СТРОКА: заменил edit_team_profile на edit_profile -->
                <a href="{% url 'edit_profile' %}" class="btn btn-edit">
                    Редактировать профиль
                </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Контент профиля -->
    <div class="profile-content">
        {% if profile_user.user_type == 'player' %}
            <!-- Профиль игрока -->
            {% if player_profile %}
            <div class="profile-stats">
                <h2>Статистика CS2</h2>

                <div class="stats-grid">
                    <div class="stat-card stat-level">
                        <div class="stat-label">Уровень</div>
                        <div class="stat-value">{{ player_profile.level|default:"-" }}</div>
                        {% if player_profile.skill_level %}
                        <div class="stat-sub">Faceit: {{ player_profile.skill_level }}</div>
                        {% endif %}
                    </div>

                    <div class="stat-card stat-elo">
                        <div class="stat-label">ELO</div>
                        <div class="stat-value">{{ player_profile.elo|default:"-" }}</div>
                    </div>

                    <div class="stat-card stat-winrate">
                        <div class="stat-label">Винрейт</div>
                        <div class="stat-value">{{ player_profile.win_rate|default:"-" }}%</div>
                        <div class="stat-sub">{{ player_profile.wins }}/{{ player_profile.matches }}</div>
                    </div>

                    <div class="stat-card stat-kd">
                        <div class="stat-label">K/D</div>
                        <div class="stat-value">{{ player_profile.average_kd|default:"-"|floatformat:2 }}</div>
                    </div>

                    <div class="stat-card stat-hs">
                        <div class="stat-label">HS%</div>
                        <div class="stat-value">{{ player_profile.average_hs|default:"-"|floatformat:1 }}%</div>
                    </div>

                    <div class="stat-card stat-streak">
                        <div class="stat-label">Серия побед</div>
                        <div class="stat-value">{{ player_profile.current_win_streak|default:"-" }}</div>
                        <div class="stat-sub">Лучшая: {{ player_profile.longest_win_streak|default:"-" }}</div>
                    </div>
                </div>

                <!-- Дополнительная информация -->
                <div class="profile-details">
                    <div class="details-grid">
                        {% if player_profile.country %}
                        <div class="detail-item">
                            <strong>Страна:</strong>
                            {{ player_profile.country|upper }}
                        </div>
                        {% endif %}

                        {% if player_profile.region %}
                        <div class="detail-item">
                            <strong>Регион:</strong> {{ player_profile.region }}
                        </div>
                        {% endif %}

                        {% if player_profile.steam_id %}
                        <div class="detail-item">
                            <strong>Steam ID:</strong>
                            <a href="https://steamcommunity.com/profiles/{{ player_profile.steam_id }}"
                               target="_blank" class="steam-link">
                                {{ player_profile.steam_id }}
                            </a>
                        </div>
                        {% endif %}

                        {% if player_profile.faceit_player_id %}
                        <div class="detail-item">
                            <strong>Faceit ID:</strong> {{ player_profile.faceit_player_id }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Данные из анкеты -->
                <div class="profile-registration">
                    <h3>Данные из анкеты</h3>
                    <div class="roles-grid">
                        <div class="roles-column">
                            <h4>CT</h4>
                            <div class="roles-list">
                                <div class="role-item">
                                    <span>Mirage</span>
                                    <strong>{{ player_profile.get_mirage_ct_position_display }}</strong>
                                </div>
                                <div class="role-item">
                                    <span>Dust 2</span>
                                    <strong>{{ player_profile.get_dust2_ct_position_display }}</strong>
                                </div>
                                <div class="role-item">
                                    <span>Anubis</span>
                                    <strong>{{ player_profile.get_anubis_ct_position_display }}</strong>
                                </div>
                                <div class="role-item">
                                    <span>Nuke</span>
                                    <strong>{{ player_profile.get_nuke_ct_position_display }}</strong>
                                </div>
                                <div class="role-item">
                                    <span>Ancient</span>
                                    <strong>{{ player_profile.get_ancient_ct_position_display }}</strong>
                                </div>
                                <div class="role-item">
                                    <span>Inferno</span>
                                    <strong>{{ player_profile.get_inferno_ct_position_display }}</strong>
                                </div>
                                <div class="role-item">
                                    <span>Overpass</span>
                                    <strong>{{ player_profile.get_overpass_ct_position_display }}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="roles-column">
                            <h4>T</h4>
                            <div class="roles-list">
                                <div class="role-item">
                                    <span>Роль</span>
                                    <strong>{{ player_profile.get_t_role_display }}</strong>
                                </div>
                                <div class="role-item">
                                    <span>IGL</span>
                                    {% if player_profile.is_igl %}
                                        <strong class="status-active">Да</strong>
                                    {% else %}
                                        <strong class="status-inactive">Нет</strong>
                                    {% endif %}
                                </div>
                                <div class="role-item">
                                    <span>AWP</span>
                                    {% if player_profile.can_awp %}
                                        <strong class="status-active">Да</strong>
                                    {% else %}
                                        <strong class="status-inactive">Нет</strong>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if player_profile.description %}
                    <div class="role-description">
                        {{ player_profile.description|linebreaks }}
                    </div>
                    {% endif %}
                </div>

                <div id="analytics-root"
                     class="analytics-card"
                     data-profile-id="{{ player_profile.id }}"
                     data-job-id="{% if analytics_job %}{{ analytics_job.id }}{% endif %}"
                     data-job-status="{% if analytics_job %}{{ analytics_job.status }}{% endif %}"
                     data-period="{{ analytics_period|default:'last_20' }}"
                     data-can-trigger="{% if can_trigger_analytics %}1{% else %}0{% endif %}">
                    <div class="analytics-header">
                        <h3>Аналитика</h3>
                        <div class="analytics-actions">
                            <form method="post" action="{% url 'analyze_profile' player_profile.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="force_heatmaps" value="1">
                                <input type="hidden" name="map" value="{{ analytics_map|default:'de_mirage' }}">
                                <button type="submit"
                                        id="analytics-start"
                                        class="btn btn-update"
                                        {% if analytics_job_active or not can_trigger_analytics %}disabled{% endif %}>
                                    {{ analytics_button_label }}
                                </button>
                            </form>
                            <form method="post" action="{% url 'analyze_profile' player_profile.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="force" value="1">
                                <input type="hidden" name="force_heatmaps" value="1">
                                <input type="hidden" name="map" value="{{ analytics_map|default:'de_mirage' }}">
                                <button type="submit"
                                        class="btn btn-link"
                                        {% if analytics_job_active or not can_trigger_analytics %}disabled{% endif %}>
                                    Полный пересчет
                                </button>
                            </form>
                        </div>
                    </div>
                    <div id="analytics-status" class="analytics-meta">
                        {% if analytics_job %}
                            {% if analytics_job.status == "FAILED" %}
                                Ошибка обработки аналитики.
                            {% elif analytics_job.status == "SUCCESS" or analytics_job.status == "DONE" %}
                                Аналитика готова.
                            {% else %}
                                Аналитика в обработке… {{ analytics_job.progress }}%
                            {% endif %}
                        {% elif analytics_ready %}
                            Аналитика готова.
                        {% else %}
                            Аналитика ещё не готова.
                        {% endif %}
                    </div>
                    {% if analytics_metrics.demo_features_approx %}
                        <div class="analytics-meta">
                            Демо не найдено — роль/utility/timing будут приближенно.
                        </div>
                    {% endif %}
                    {% if analytics_job and analytics_job.status == "FAILED" and analytics_job.error %}
                        <pre class="analytics-error">{{ analytics_job.error|truncatechars:220 }}</pre>
                    {% endif %}
                    {% if analytics_aggregates %}
                        <div class="analytics-metrics">
                            {% for key, value in analytics_simple_metrics.items %}
                                <div class="analytics-metric">
                                    <span class="metric-label">{{ key }}</span>
                                    <strong class="metric-value">{{ value }}</strong>
                                </div>
                            {% empty %}
                                <div class="analytics-metric">
                                    <span class="metric-label">Metrics</span>
                                    <strong class="metric-value">Нет данных</strong>
                                </div>
                            {% endfor %}
                        </div>
                        {% if analytics_metrics.kda %}
                            <div class="analytics-metrics analytics-metrics--kda">
                                <div class="analytics-metric">
                                    <span class="metric-label">Kills</span>
                                    <strong class="metric-value">{{ analytics_metrics.kda.kills }}</strong>
                                </div>
                                <div class="analytics-metric">
                                    <span class="metric-label">Deaths</span>
                                    <strong class="metric-value">{{ analytics_metrics.kda.deaths }}</strong>
                                </div>
                                <div class="analytics-metric">
                                    <span class="metric-label">Assists</span>
                                    <strong class="metric-value">{{ analytics_metrics.kda.assists }}</strong>
                                </div>
                                <div class="analytics-metric">
                                    <span class="metric-label">KDA</span>
                                    <strong class="metric-value">
                                        {% if analytics_metrics.kda.kda_ratio != None %}
                                            {{ analytics_metrics.kda.kda_ratio|floatformat:2 }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>

                <div class="analytics-card role-fingerprint-card">
                    <div class="analytics-header">
                        <h3>Role fingerprint</h3>
                    </div>
                    {% if analytics_metrics.role_fingerprint %}
                        {% if analytics_metrics.role_fingerprint.debug %}
                            {% if analytics_metrics.role_fingerprint.debug.demos_count == 0 %}
                                <div class="analytics-empty">Upload demos to enable advanced metrics.</div>
                            {% elif analytics_metrics.role_fingerprint.debug.rounds_count < analytics_metrics.role_fingerprint.debug.min_rounds_required %}
                                <div class="analytics-empty">Not enough rounds yet.</div>
                            {% endif %}
                        {% endif %}
                        <div class="role-tags">
                            {% for tag in analytics_metrics.role_fingerprint.tags %}
                                <span class="role-chip">{{ tag }}</span>
                            {% empty %}
                                <span class="role-chip role-chip--empty">Not enough data</span>
                            {% endfor %}
                            {% if analytics_metrics.role_fingerprint.approx %}
                                <span class="role-chip role-chip--approx">approx</span>
                            {% endif %}
                        </div>
                        <div class="role-summary">
                            {{ analytics_metrics.role_fingerprint.summary }}
                        </div>
                        <div class="role-metrics-grid">
                            <div class="role-metric">
                                <span>First duel / round</span>
                                <strong>
                                    {% if analytics_metrics.role_fingerprint.metrics.first_duel_attempts_per_round.value != None %}
                                        {{ analytics_metrics.role_fingerprint.metrics.first_duel_attempts_per_round.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="role-metric">
                                <span>First duel success</span>
                                <strong>
                                    {% if analytics_metrics.role_fingerprint.metrics.first_duel_success_rate.value != None %}
                                        {{ analytics_metrics.role_fingerprint.metrics.first_duel_success_rate.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="role-metric">
                                <span>Trade kill rate</span>
                                <strong>
                                    {% if analytics_metrics.role_fingerprint.metrics.trade_kill_rate.value != None %}
                                        {{ analytics_metrics.role_fingerprint.metrics.trade_kill_rate.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="role-metric">
                                <span>Traded death rate</span>
                                <strong>
                                    {% if analytics_metrics.role_fingerprint.metrics.traded_death_rate.value != None %}
                                        {{ analytics_metrics.role_fingerprint.metrics.traded_death_rate.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="role-metric">
                                <span>Clutch win rate</span>
                                <strong>
                                    {% if analytics_metrics.role_fingerprint.metrics.clutch_win_rate.value != None %}
                                        {{ analytics_metrics.role_fingerprint.metrics.clutch_win_rate.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="role-metric">
                                <span>Flash assists / round</span>
                                <strong>
                                    {% if analytics_metrics.role_fingerprint.metrics.flash_assists_per_round.value != None %}
                                        {{ analytics_metrics.role_fingerprint.metrics.flash_assists_per_round.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                    {% else %}
                        <div class="analytics-empty">Not enough data</div>
                    {% endif %}
                </div>

                <div class="analytics-card playstyle-card">
                    <div class="analytics-header">
                        <h3>Playstyle archetype</h3>
                    </div>
                    {% if analytics_metrics.playstyle %}
                        <div class="playstyle-label">
                            <strong>{{ analytics_metrics.playstyle.label }}</strong>
                            {% if analytics_metrics.playstyle.approx %}
                                <span class="role-chip role-chip--approx">approx</span>
                            {% endif %}
                        </div>
                        <ul class="playstyle-reasons">
                            {% for reason in analytics_metrics.playstyle.reasons %}
                                <li>{{ reason }}</li>
                            {% empty %}
                                <li>Not enough data for reasons.</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="analytics-empty">Not enough data</div>
                    {% endif %}
                </div>

                <div class="analytics-card utility-iq-card">
                    <div class="analytics-header">
                        <h3>Utility IQ</h3>
                    </div>
                    {% if analytics_metrics.utility_iq %}
                        <div class="utility-score">
                            <span>Score</span>
                            <strong>
                                {% if analytics_metrics.utility_iq.score != None %}
                                    {{ analytics_metrics.utility_iq.score }}
                                {% else %}
                                    not enough data
                                {% endif %}
                            </strong>
                            {% if analytics_metrics.utility_iq.approx %}
                                <span class="role-chip role-chip--approx">approx</span>
                            {% endif %}
                        </div>
                        <div class="utility-breakdown">
                            <div>
                                <span>Flash assists / round</span>
                                <strong>
                                    {% if analytics_metrics.utility_iq.breakdown.flash_assists_per_round.value != None %}
                                        {{ analytics_metrics.utility_iq.breakdown.flash_assists_per_round.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                            <div>
                                <span>Utility damage / round</span>
                                <strong>
                                    {% if analytics_metrics.utility_iq.breakdown.utility_damage_per_round.value != None %}
                                        {{ analytics_metrics.utility_iq.breakdown.utility_damage_per_round.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                            <div>
                                <span>Friendly flash rate</span>
                                <strong>
                                    {% if analytics_metrics.utility_iq.breakdown.friendly_flash_rate.value != None %}
                                        {{ analytics_metrics.utility_iq.breakdown.friendly_flash_rate.value|floatformat:2 }}
                                    {% else %}
                                        not enough data
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                    {% else %}
                        <div class="analytics-empty">Not enough data</div>
                    {% endif %}
                </div>

                <div class="analytics-card timing-control-card">
                    <div class="analytics-header">
                        <h3>Timing control</h3>
                    </div>
                    {% if analytics_metrics.timing_slices %}
                        <table class="timing-table">
                            <thead>
                                <tr>
                                    <th>Window</th>
                                    <th>Contacts</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bucket in analytics_metrics.timing_slices.buckets %}
                                    <tr>
                                        <td>{{ bucket.label }}</td>
                                        <td>
                                            {% if bucket.value != None %}
                                                {{ bucket.value|floatformat:1 }}%
                                            {% else %}
                                                not enough data
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="2">not enough data</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if analytics_metrics.timing_slices.approx %}
                            <div class="analytics-approx">approx</div>
                        {% endif %}
                    {% else %}
                        <div class="analytics-empty">Not enough data</div>
                    {% endif %}
                </div>

                <div class="analytics-card awareness-card">
                    <div class="analytics-header">
                        <h3>Awareness before death</h3>
                    </div>
                    {% if analytics_metrics.awareness_before_death %}
                        <div class="analytics-metrics">
                            <div class="analytics-metric">
                                <span class="metric-label">Awareness %</span>
                                <strong class="metric-value">
                                    {% if analytics_metrics.awareness_before_death.awareness_before_death_rate != None %}
                                        {{ analytics_metrics.awareness_before_death.awareness_before_death_rate|floatformat:2 }}%
                                    {% else %}
                                        —
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="analytics-metric">
                                <span class="metric-label">Aware deaths</span>
                                <strong class="metric-value">{{ analytics_metrics.awareness_before_death.aware_deaths }}</strong>
                            </div>
                            <div class="analytics-metric">
                                <span class="metric-label">Total deaths</span>
                                <strong class="metric-value">{{ analytics_metrics.awareness_before_death.total_deaths }}</strong>
                            </div>
                        </div>
                    {% else %}
                        <div class="analytics-empty">Not enough data</div>
                    {% endif %}
                </div>

                <div class="analytics-card multikill-card">
                    <div class="analytics-header">
                        <h3>Multi-kill breakdown</h3>
                    </div>
                    {% if analytics_metrics.multikill %}
                        <div class="analytics-metrics">
                            <div class="analytics-metric">
                                <span class="metric-label">Multi-kill rate</span>
                                <strong class="metric-value">
                                    {% if analytics_metrics.multikill.multikill_round_rate != None %}
                                        {{ analytics_metrics.multikill.multikill_round_rate|floatformat:2 }}%
                                    {% else %}
                                        —
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="analytics-metric">
                                <span class="metric-label">Events</span>
                                <strong class="metric-value">{{ analytics_metrics.multikill.multikill_events }}</strong>
                            </div>
                            <div class="analytics-metric">
                                <span class="metric-label">Early/late</span>
                                <strong class="metric-value">
                                    {{ analytics_metrics.multikill.by_timing.early|default:"0" }} /
                                    {{ analytics_metrics.multikill.by_timing.late|default:"0" }}
                                </strong>
                            </div>
                        </div>
                    {% else %}
                        <div class="analytics-empty">Not enough data</div>
                    {% endif %}
                </div>

                <div id="heatmaps-root"
                     class="heatmaps-card"
                     data-profile-id="{{ player_profile.id }}"
                     data-map="{{ analytics_map|default:'de_mirage' }}"
                     data-period="{{ analytics_period|default:'last_20' }}"
                     data-version="{{ analytics_version|default:'v2' }}"
                     data-resolution="256"
                     data-metric="kills"
                     data-slice="{{ heatmap_default_slice|default:'0-15' }}"
                     data-slices="{{ heatmap_time_slices|join:',' }}"
                     data-can-trigger="{% if can_trigger_analytics %}1{% else %}0{% endif %}">
                    <div class="heatmaps-header">
                        <div>
                            <h3>Heatmaps</h3>
                            <div class="heatmaps-controls">
                                <label class="heatmaps-label" for="hm-map">Карта</label>
                                <select id="hm-map" class="heatmaps-select">
                                    {% for map_name in available_maps %}
                                        <option value="{{ map_name }}"
                                                {% if map_name == analytics_map %}selected{% endif %}>
                                            {{ map_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <label class="heatmaps-label" for="hm-slice">Время раунда</label>
                                <div class="heatmaps-slider">
                                    <input id="hm-slice" type="range" min="0" max="{{ heatmap_time_slices|length|add:'-1' }}"
                                           step="1" value="0" />
                                    <span id="hm-slice-label" class="heatmaps-meta heatmaps-meta--inline"></span>
                                </div>
                                <label class="heatmaps-label" for="hm-resolution">Grid</label>
                                <select id="hm-resolution" class="heatmaps-select">
                                    <option value="64">64</option>
                                    <option value="128">128</option>
                                    <option value="256">256</option>
                                </select>
                            </div>
                            <div class="heatmaps-tabs" data-group="metric">
                                <button type="button" class="hm-tab active" data-group="metric" data-value="kills">
                                    Kills
                                </button>
                                <button type="button" class="hm-tab" data-group="metric" data-value="deaths">
                                    Deaths
                                </button>
                                <button type="button" class="hm-tab" data-group="metric" data-value="presence">
                                    Presence
                                </button>
                            </div>
                            <div class="heatmaps-tabs heatmaps-tabs--secondary" data-group="side">
                                <button type="button" class="hm-tab active" data-group="side" data-value="ALL">All</button>
                                <button type="button" class="hm-tab" data-group="side" data-value="CT">CT</button>
                                <button type="button" class="hm-tab" data-group="side" data-value="T">T</button>
                            </div>
                        </div>
                    </div>

                    <div id="hm-status" class="heatmaps-meta">Загрузка тепловой карты…</div>
                    <div id="hm-spinner" class="heatmaps-spinner" aria-hidden="true"></div>
                    <div class="heatmaps-body">
                        <img id="hm-img" class="heatmap-img" alt="heatmap" loading="lazy" />
                        <div class="heatmaps-actions">
                            <button id="hm-regenerate" type="button" class="heatmaps-btn">
                                Обновить картинки
                            </button>
                            <span id="hm-regenerate-status" class="heatmaps-meta heatmaps-meta--inline" aria-live="polite"></span>
                        </div>
                    </div>
                </div>

                <!-- Информация о последнем обновлении -->
                {% if player_profile.last_faceit_update %}
                <div class="update-info">
                    <p>
                        <small>
                            Данные обновлены: {{ player_profile.last_faceit_update|date:"d.m.Y H:i" }}
                            {% if days_since_update %}
                                ({{ days_since_update }} дней назад)
                            {% endif %}
                        </small>
                    </p>
                </div>
                {% endif %}

            </div>
            {% else %}
            <div class="empty-profile">
                <h3>Профиль игрока не найден</h3>
                <p>Нажмите кнопку "Обновить с Faceit" чтобы создать профиль</p>
            </div>
            {% endif %}

        {% else %}
            <!-- Профиль команды -->
            {% if team_profile %}
            <div class="team-profile">
                <div class="team-info">
                    <h2>Информация о команде</h2>

                    <div class="team-card">
                        <div class="team-main">
                            <h3>{{ team_profile.team_name }}</h3>

                            {% if team_profile.description %}
                            <div class="team-description">
                                {{ team_profile.description|linebreaks }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="team-requirements">
                            <h4>Требования к игрокам:</h4>
                            <div class="requirements-grid">
                                <div class="requirement-item">
                                    <strong>Ищем IGL:</strong>
                                    {% if team_profile.looking_for_igl %}
                                        <span class="status-active">Да</span>
                                    {% else %}
                                        <span class="status-inactive">Нет</span>
                                    {% endif %}
                                </div>
                                
                                <div class="requirement-item">
                                    <strong>Ищем AWP-иста:</strong>
                                    {% if team_profile.looking_for_awper %}
                                        <span class="status-active">Да</span>
                                    {% else %}
                                        <span class="status-inactive">Нет</span>
                                    {% endif %}
                                </div>

                                <div class="requirement-item">
                                    <strong>Статус:</strong>
                                    {% if team_profile.is_active %}
                                        <span class="status-active">Активна</span>
                                    {% else %}
                                        <span class="status-inactive">Неактивна</span>
                                    {% endif %}
                                </div>

                                <div class="requirement-item">
                                    <strong>Создана:</strong>
                                    {{ team_profile.created_date|date:"d.m.Y" }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Кнопка редактирования для владельца команды -->
                {% if request.user == team_profile.user %}
                <div class="team-actions">
                    <a href="{% url 'edit_profile' %}" class="btn btn-edit">
                        Редактировать профиль команды
                    </a>
                </div>
                {% endif %}

            </div>
            {% else %}
            <div class="empty-profile">
                <h3>Профиль команды не найден</h3>
                <p>Нажмите кнопку "Редактировать профиль" чтобы создать профиль</p>
            </div>
            {% endif %}
        {% endif %}
    </div>
</div>

<style>
    /* Profile Styles */
    .profile-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .profile-header {
        display: flex;
        align-items: center;
        padding: 2rem;
        background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
        color: white;
        gap: 2rem;
    }

    .profile-avatar {
        flex-shrink: 0;
    }

    .avatar-img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.3);
        object-fit: cover;
    }

    .avatar-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        border: 4px solid rgba(255, 255, 255, 0.3);
    }

    .profile-info {
        flex-grow: 1;
    }

    .profile-info h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2rem;
    }

    .profile-badges {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .badge-player {
        background: #4cc9f0;
        color: white;
    }

    .badge-team {
        background: #f72585;
        color: white;
    }

    .badge-admin {
        background: #ffba08;
        color: #333;
    }

    .badge-verified {
        background: #06d6a0;
        color: white;
    }

    .profile-faceit,
    .profile-email,
    .profile-date {
        margin: 0.25rem 0;
        font-size: 0.95rem;
    }

    .faceit-link {
        color: #4cc9f0;
        text-decoration: none;
    }

    .faceit-link:hover {
        text-decoration: underline;
    }

    .profile-actions {
        display: flex;
        gap: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-update {
        background: #06d6a0;
        color: white;
    }

    .btn-update:hover {
        background: #05b888;
        transform: translateY(-2px);
    }

    .btn-edit {
        background: #7209b7;
        color: white;
    }

    .btn-edit:hover {
        background: #5a0891;
        transform: translateY(-2px);
    }

    .profile-content {
        padding: 2rem;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .stat-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: #4361ee;
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .stat-sub {
        font-size: 0.85rem;
        color: #6c757d;
    }

    /* Details Grid */
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
    }

    .detail-item--full {
        grid-column: 1 / -1;
        align-items: flex-start;
    }

    .roles-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .roles-column h4 {
        margin: 0 0 0.75rem;
        font-size: 1rem;
        color: #343a40;
        text-transform: uppercase;
        letter-spacing: 0.6px;
    }

    .roles-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .role-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.35rem 0.2rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-size: 0.95rem;
    }

    .role-item span {
        color: #6c757d;
    }

    .role-description {
        margin-top: 1rem;
        padding: 1rem 1.25rem;
        border-radius: 10px;
        background: #f8f9fa;
        color: #495057;
    }

    .analytics-card {
        padding: 1.5rem;
        border-radius: 12px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        margin: 2rem 0;
    }

    .analytics-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .analytics-meta {
        margin-top: 0.5rem;
        color: #6c757d;
        font-size: 0.95rem;
    }

    .analytics-error {
        background: #fff5f5;
        border: 1px solid #f5c2c2;
        color: #b42318;
        padding: 0.75rem;
        border-radius: 8px;
        margin-top: 0.75rem;
        white-space: pre-wrap;
    }

    .analytics-metrics {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
    }

    .analytics-metrics--kda {
        margin-top: 0.75rem;
    }

    .analytics-metric {
        background: #fff;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 1px solid #e9ecef;
    }

    .analytics-metric .metric-label {
        display: block;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .analytics-metric .metric-value {
        font-size: 1.1rem;
        color: #1d2939;
    }

    .analytics-empty {
        margin-top: 1rem;
        color: #6c757d;
    }

    .role-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .role-chip {
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        background: #4cc9f0;
        color: #fff;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .role-chip--empty {
        background: #adb5bd;
    }

    .role-chip--approx {
        background: #f59f00;
    }

    .role-summary {
        margin-top: 0.75rem;
        color: #495057;
        font-size: 0.95rem;
    }

    .playstyle-card .playstyle-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .playstyle-reasons {
        margin: 0.5rem 0 0;
        padding-left: 1.1rem;
        color: #6c757d;
    }

    .role-metrics-grid {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .role-metric {
        padding: 0.75rem 1rem;
        background: #fff;
        border-radius: 10px;
        border: 1px solid #e9ecef;
    }

    .role-metric span {
        display: block;
        color: #6c757d;
        font-size: 0.85rem;
    }

    .utility-score {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .utility-score strong {
        font-size: 1.4rem;
    }

    .utility-breakdown {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .utility-breakdown div {
        padding: 0.75rem 1rem;
        background: #fff;
        border-radius: 10px;
        border: 1px solid #e9ecef;
    }

    .utility-breakdown span {
        display: block;
        color: #6c757d;
        font-size: 0.85rem;
    }

    .timing-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .timing-table th,
    .timing-table td {
        padding: 0.6rem 0.75rem;
        border-bottom: 1px solid #e9ecef;
        text-align: left;
    }

    .analytics-approx {
        margin-top: 0.5rem;
        color: #f59f00;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .heatmaps-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .heatmaps-card {
        padding: 1.5rem;
        border-radius: 12px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        margin: 2rem 0;
    }

    .heatmaps-card .heatmaps-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .heatmaps-tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .heatmaps-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .heatmaps-slider {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    #hm-slice {
        width: 140px;
    }

    .heatmaps-label {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .heatmaps-select {
        padding: 0.4rem 0.6rem;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.12);
        background: #fff;
    }

    .heatmaps-tabs--secondary {
        margin-top: 0.65rem;
    }

    .hm-tab {
        padding: 0.5rem 0.9rem;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.12);
        background: transparent;
        color: #343a40;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .hm-tab.active,
    .hm-tab:hover {
        background: rgba(67, 97, 238, 0.12);
        border-color: rgba(67, 97, 238, 0.35);
    }

    .heatmaps-meta {
        margin: 0.75rem 0 1rem;
        color: #6c757d;
        font-size: 0.95rem;
    }

    .heatmaps-meta--inline {
        margin: 0;
    }

    .heatmaps-spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid rgba(67, 97, 238, 0.2);
        border-top-color: #4361ee;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
        display: none;
    }

    .heatmaps-spinner.is-active {
        display: inline-block;
    }

    .heatmaps-body img {
        max-width: 100%;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        background: #fff;
    }

    .heatmaps-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.75rem;
        flex-wrap: wrap;
    }

    .heatmaps-btn {
        background: #1f5cff;
        border: none;
        color: #fff;
        font-weight: 600;
        padding: 0.45rem 0.85rem;
        border-radius: 10px;
        cursor: pointer;
        transition: opacity 0.2s ease;
    }

    .heatmaps-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .heatmap-img {
        width: 520px;
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: 14px;
    }

    .flag {
        font-size: 1.2rem;
    }

    .steam-link {
        color: #4361ee;
        text-decoration: none;
    }

    .steam-link:hover {
        text-decoration: underline;
    }

    /* Team Profile */
    .team-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 2rem;
        margin: 1rem 0;
    }

    .team-main {
        margin-bottom: 2rem;
    }

    .team-description {
        line-height: 1.8;
        color: #555;
        margin-top: 1rem;
    }

    .requirements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .requirement-item {
        padding: 1rem;
        background: white;
        border-radius: 6px;
        border-left: 4px solid #4361ee;
    }

    .status-active {
        color: #06d6a0;
        font-weight: 500;
    }

    .status-inactive {
        color: #ef476f;
        font-weight: 500;
    }

    .team-actions {
        text-align: center;
        margin-top: 2rem;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    /* Empty Profile */
    .empty-profile {
        text-align: center;
        padding: 4rem 2rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px dashed #dee2e6;
    }

    .empty-profile h3 {
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .empty-profile p {
        color: #6c757d;
    }

    /* Update Info */
    .update-info {
        text-align: center;
        padding: 1rem;
        background: #e9ecef;
        border-radius: 6px;
        margin-top: 2rem;
    }

    .update-info small {
        color: #6c757d;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .profile-header {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem;
        }

        .profile-actions {
            flex-direction: column;
            width: 100%;
        }

        .profile-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .player-card {
            flex-direction: column;
            text-align: center;
        }

        .heatmaps-card .heatmaps-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .details-grid {
            grid-template-columns: 1fr;
        }

        .roles-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const analyticsRoot = document.getElementById("analytics-root");
        const analyticsStatus = document.getElementById("analytics-status");
        const analyticsStart = document.getElementById("analytics-start");
        const profileId = analyticsRoot?.dataset?.profileId;
        let currentJobId = analyticsRoot?.dataset?.jobId;
        let currentJobStatus = analyticsRoot?.dataset?.jobStatus;

        function getCookie(name) {
            const cookieValue = document.cookie
                .split("; ")
                .find((row) => row.startsWith(`${name}=`));
            return cookieValue ? decodeURIComponent(cookieValue.split("=")[1]) : null;
        }

        function setAnalyticsStatus(text) {
            if (analyticsStatus) {
                analyticsStatus.textContent = text;
            }
        }

        async function pollJob(jobId) {
            try {
                const r = await fetch(`/api/analytics/jobs/${jobId}`, {
                    headers: { Accept: "application/json" },
                });
                if (!r.ok) {
                    setAnalyticsStatus("Не удалось получить статус обработки.");
                    return;
                }
                const data = await r.json();
                currentJobStatus = data.status;
                if (data.status === "SUCCESS") {
                    setAnalyticsStatus("Аналитика готова.");
                    window.location.reload();
                    return;
                }
                if (data.status === "FAILED") {
                    setAnalyticsStatus("Ошибка обработки аналитики.");
                    if (analyticsStart) {
                        analyticsStart.disabled = false;
                    }
                    return;
                }
                setAnalyticsStatus(`Аналитика в обработке… ${data.progress || 0}%`);
            } catch (e) {
                setAnalyticsStatus("Ошибка при проверке статуса.");
            }
        }

        if (
            currentJobId &&
            (currentJobStatus === "PENDING" ||
                currentJobStatus === "STARTED" ||
                currentJobStatus === "PROCESSING" ||
                currentJobStatus === "RUNNING")
        ) {
            setAnalyticsStatus("Аналитика в обработке…");
            if (analyticsStart) {
                analyticsStart.disabled = true;
            }
            setInterval(() => pollJob(currentJobId), 2000);
        }

        if (analyticsStart && profileId) {
            analyticsStart.addEventListener("click", async () => {
                analyticsStart.disabled = true;
                setAnalyticsStatus("Запуск обработки…");
                try {
                    const mapValue = (document.getElementById("hm-map")?.value || "de_mirage").trim();
                    const r = await fetch(`/api/analytics/${profileId}/start`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken"),
                        },
                        body: JSON.stringify({ map: mapValue }),
                    });
                    let data = null;
                    if (r.ok) {
                        data = await r.json();
                    } else {
                        try {
                            data = await r.json();
                        } catch (e) {
                            data = null;
                        }
                    }
                    if (!r.ok || !data) {
                        setAnalyticsStatus(data?.error || "Не удалось запустить обработку.");
                        analyticsStart.disabled = false;
                        return;
                    }
                    currentJobId = data.job_id;
                    currentJobStatus = data.status;
                    setAnalyticsStatus("Аналитика в обработке…");
                    setInterval(() => pollJob(currentJobId), 2000);
                } catch (e) {
                    setAnalyticsStatus("Ошибка запуска обработки.");
                    analyticsStart.disabled = false;
                }
            });
        }

        const root = document.getElementById("heatmaps-root");
        const status = document.getElementById("hm-status");
        const img = document.getElementById("hm-img");
        const sideTabs = Array.from(document.querySelectorAll('.hm-tab[data-group="side"]'));
        const metricTabs = Array.from(document.querySelectorAll('.hm-tab[data-group="metric"]'));
        const mapSelect = document.getElementById("hm-map");
        const resolutionSelect = document.getElementById("hm-resolution");
        const sliceInput = document.getElementById("hm-slice");
        const sliceLabel = document.getElementById("hm-slice-label");
        const spinner = document.getElementById("hm-spinner");
        const regenerateBtn = document.getElementById("hm-regenerate");
        const regenerateStatus = document.getElementById("hm-regenerate-status");
        const heatmapProfileId = (root?.dataset?.profileId || "").trim();
        const defaultMap = (root?.dataset?.map || "de_mirage").trim() || "de_mirage";
        const period = (root?.dataset?.period || "last_20").trim() || "last_20";
        const version = (root?.dataset?.version || "v2").trim() || "v2";
        const resolution = (root?.dataset?.resolution || "256").trim() || "256";
        const defaultMetric = (root?.dataset?.metric || "kills").trim().toLowerCase() || "kills";
        const sliceOptions = (root?.dataset?.slices || "0-15")
            .split(",")
            .map((v) => v.trim())
            .filter(Boolean);
        const defaultSlice = (root?.dataset?.slice || sliceOptions[0] || "0-15").trim();
        const canTrigger = (root?.dataset?.canTrigger || "0").trim() === "1";

        function setActive(tabs, value) {
            tabs.forEach((t) => t.classList.toggle("active", t.dataset.value === value));
        }

        if (!heatmapProfileId) {
            status.textContent = "Heatmaps недоступны.";
            return;
        }

        if (mapSelect) {
            mapSelect.value = defaultMap;
        }
        if (resolutionSelect) {
            resolutionSelect.value = resolution;
        }
        let currentSliceIndex = Math.max(sliceOptions.indexOf(defaultSlice), 0);
        let currentSlice = sliceOptions[currentSliceIndex] || defaultSlice;
        if (sliceInput && sliceOptions.length) {
            sliceInput.max = `${Math.max(sliceOptions.length - 1, 0)}`;
            sliceInput.value = `${currentSliceIndex}`;
        }
        if (sliceLabel) {
            sliceLabel.textContent = currentSlice;
        }

        let currentSide = "ALL";
        let currentMap = defaultMap;
        let currentMetric = defaultMetric;
        let currentResolution = resolution;
        let pollingTimer = null;
        let pollAttempts = 0;
        const maxPollAttempts = 10;
        const regenerateLabel = regenerateBtn ? regenerateBtn.textContent.trim() : "";

        function setLoading(isLoading) {
            if (spinner) {
                spinner.classList.toggle("is-active", isLoading);
                spinner.setAttribute("aria-hidden", isLoading ? "false" : "true");
            }
        }

        function setRegenerating(isRegenerating) {
            if (!regenerateBtn || !regenerateStatus) {
                return;
            }
            regenerateBtn.disabled = isRegenerating;
            regenerateStatus.textContent = isRegenerating ? "Обновляю…" : "";
            if (regenerateBtn) {
                regenerateBtn.textContent = isRegenerating ? "Обновляю…" : regenerateLabel;
            }
        }

        function setMissingMessage() {
            status.textContent = canTrigger
                ? "Нет данных. Нажмите «Проанализировать» в блоке аналитики."
                : "Нет данных.";
        }

        function clearPolling() {
            if (pollingTimer) {
                clearTimeout(pollingTimer);
            }
            pollingTimer = null;
        }

        async function fetchHeatmap({ force = false } = {}) {
            clearPolling();
            pollAttempts = 0;
            status.textContent = "Загрузка тепловой карты…";
            setLoading(true);
            img.style.display = "none";
            let waitingForImage = false;

            const apiUrl = `/api/heatmaps/me` +
                `?map=${encodeURIComponent(currentMap)}` +
                `&metric=${encodeURIComponent(currentMetric)}` +
                `&side=${encodeURIComponent(currentSide)}` +
                `&period=${encodeURIComponent(period)}` +
                `&slice=${encodeURIComponent(currentSlice)}` +
                `&v=${encodeURIComponent(version)}` +
                `&res=${encodeURIComponent(currentResolution)}` +
                (force ? "&force=1" : "");

            try {
                const r = await fetch(apiUrl, { headers: { Accept: "application/json" } });
                if (!r.ok) {
                    status.textContent = "Не удалось загрузить heatmap.";
                    if (force) {
                        alert("Не удалось обновить картинку.");
                    }
                    setLoading(false);
                    return;
                }
                const data = await r.json();
                if (data.status === "ready" && data.image_url) {
                    img.style.display = "block";
                    const cacheBusted = force
                        ? `${data.image_url}${data.image_url.includes("?") ? "&" : "?"}cb=${Date.now()}`
                        : data.image_url;
                    waitingForImage = true;
                    img.onload = () => {
                        status.textContent = "";
                        setLoading(false);
                        setRegenerating(false);
                    };
                    img.onerror = () => {
                        status.textContent = "Не удалось загрузить изображение.";
                        setLoading(false);
                        setRegenerating(false);
                        if (force) {
                            alert("Не удалось обновить картинку.");
                        }
                    };
                    img.src = cacheBusted;
                    return;
                }
                if (data.status === "processing") {
                    status.textContent = "Heatmap обрабатывается…";
                    setLoading(true);
                    pollAttempts += 1;
                    if (pollAttempts <= maxPollAttempts) {
                        pollingTimer = setTimeout(fetchHeatmap, 2500);
                    } else {
                        status.textContent = "Heatmap ещё не готова. Попробуйте позже.";
                        setLoading(false);
                    }
                    return;
                }
                setMissingMessage();
                if (force) {
                    alert("Не удалось обновить картинку.");
                }
            } catch (e) {
                status.textContent = "Ошибка при загрузке heatmap.";
                if (force) {
                    alert("Не удалось обновить картинку.");
                }
            } finally {
                if (!waitingForImage && status.textContent !== "Heatmap обрабатывается…") {
                    setLoading(false);
                }
                if (!waitingForImage && status.textContent !== "") {
                    setRegenerating(false);
                }
            }
        }

        sideTabs.forEach((t) =>
            t.addEventListener("click", () => {
                currentSide = t.dataset.value;
                setActive(sideTabs, currentSide);
                fetchHeatmap();
            })
        );

        metricTabs.forEach((t) =>
            t.addEventListener("click", () => {
                currentMetric = t.dataset.value;
                setActive(metricTabs, currentMetric);
                fetchHeatmap();
            })
        );

        if (mapSelect) {
            mapSelect.addEventListener("change", () => {
                currentMap = mapSelect.value;
                document.querySelectorAll('input[name="map"]').forEach((input) => {
                    input.value = currentMap;
                });
                const url = new URL(window.location.href);
                url.searchParams.set("map", currentMap);
                window.location.href = url.toString();
            });
        }
        if (resolutionSelect) {
            resolutionSelect.addEventListener("change", () => {
                currentResolution = resolutionSelect.value;
                fetchHeatmap();
            });
        }
        if (sliceInput) {
            sliceInput.addEventListener("input", () => {
                currentSliceIndex = parseInt(sliceInput.value, 10);
                currentSlice = sliceOptions[currentSliceIndex] || defaultSlice;
                if (sliceLabel) {
                    sliceLabel.textContent = currentSlice;
                }
                fetchHeatmap();
            });
        }

        if (regenerateBtn) {
            regenerateBtn.addEventListener("click", async () => {
                setRegenerating(true);
                status.textContent = "Обновляю изображение…";
                try {
                    await fetchHeatmap({ force: true });
                } catch (e) {
                    alert("Не удалось обновить картинку.");
                    setRegenerating(false);
                }
            });
        }

        setActive(sideTabs, currentSide);
        setActive(metricTabs, currentMetric);
        fetchHeatmap();
    });
</script>
{% endblock %}
[file content end]
